<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile</title>
  <link rel="stylesheet" href="profile.css" />
</head>
<body>
  <!-- HEADER -->
  <header class="header-bar">
    <div class="rank-display">
      <span class="rank-label">Sche</span>
      <span class="rank-title">Duler</span>
    </div>

    <div class="menu-wrapper">
      <button id="hamburger" class="hamburger-icon">&#9776;</button>
      <div id="dropdownMenu" class="dropdown-menu">
        <a href="index.html">Home</a>
        <a href="index.html#about-section">About</a>
        <button id="menuLogout">Logout</button>
        <button id="menuDelete" style="color:red;">Delete Account</button>
      </div>
    </div>
  </header>

  <!-- PROFILE INFO -->
<main>
  <div class="profile-card">
    <h2>Profile</h2>
    <p><strong>Name:</strong> <span id="profileName">-</span></p>
    <p>
      <strong>Email:</strong>
      <span id="profileEmail" style="display:none;">-</span>
      <button id="toggleEmailBtn" class="view-btn">View</button>
    </p>
  </div>

  <div class="profile-actions">
    <a href="index.html">Back to Home</a>
  </div>

  <!-- DEVICE CONNECTION SECTION -->
<section id="deviceSection">
  <h2>Devices</h2>
  <div class="add-device-box">
    <input type="text" id="deviceInput" placeholder="Enter device name or IP"/>
    <button id="connectDeviceBtn" class="action-small">Connect</button>
    <button id="disconnectDeviceBtn" class="action-small" style="display:none; background-color:red; color:white;">❌</button>
  </div>
</section>

  <!-- SWITCHES SECTION -->
  <section id="myAds">
    <h2>Switches</h2>

    <div class="add-switch-box">
      <input type="text" id="newSwitchInput" placeholder="Enter switch label (max 5)" maxlength="30"/>
      <button id="addSwitchBtn" class="action-small">Add Switch</button>
    </div>

    <div id="userAds"><p>Loading your switches...</p></div>
  </section>
</main>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const profileEmail = document.getElementById("profileEmail");
  const toggleEmailBtn = document.getElementById("toggleEmailBtn");
  const addSwitchBtn = document.getElementById("addSwitchBtn");
  const newSwitchInput = document.getElementById("newSwitchInput");
  const switchesContainer = document.getElementById("userAds");
  const dropdownMenu = document.getElementById("dropdownMenu");
  const hamburger = document.getElementById("hamburger");
  const menuLogout = document.getElementById("menuLogout");
  const menuDelete = document.getElementById("menuDelete");
  const connectDeviceBtn = document.getElementById("connectDeviceBtn");
  const disconnectDeviceBtn = document.getElementById("disconnectDeviceBtn");
  const deviceInput = document.getElementById("deviceInput");

  // --- MENU ---
  hamburger.addEventListener("click", () => {
    dropdownMenu.classList.toggle("show");
  });
  document.addEventListener("click", (e) => {
    if (!e.target.closest(".menu-wrapper")) dropdownMenu.classList.remove("show");
  });

  // --- USER LOAD ---
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user) { window.location.href = "index.html"; return; }
  document.getElementById("profileName").textContent = user.name || "User";
  profileEmail.textContent = user.email || "Unknown";

  // --- TOGGLE EMAIL ---
  toggleEmailBtn.addEventListener("click", () => {
    if (profileEmail.style.display === "none") {
      profileEmail.style.display = "inline";
      toggleEmailBtn.textContent = "Hide";
    } else {
      profileEmail.style.display = "none";
      toggleEmailBtn.textContent = "View";
    }
  });

  // --- LOGOUT ---
  menuLogout.addEventListener("click", () => {
    localStorage.removeItem("user");
    window.location.href = "index.html";
  });

  // --- DELETE ACCOUNT ---
  menuDelete.addEventListener("click", async () => {
    const confirmDel = confirm("⚠️ Are you sure you want to delete your account? This cannot be undone!");
    if (!confirmDel) return;
    try {
      const res = await fetch(`/api/auth?action=delete`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: user.email }),
      });
      const data = await res.json();
      if (data.success) {
        alert("✅ Your account has been deleted successfully.");
        localStorage.removeItem("user");
        window.location.href = "index.html";
      } else {
        alert("❌ Failed to delete account: " + (data.error || data.message || "Unknown error"));
      }
    } catch {
      alert("⚠️ Error deleting account. Please try again later.");
    }
  });

  // --- AUTO LOAD CONNECTED DEVICE ---
  async function loadDeviceStatus() {
    try {
      const res = await fetch(`/api/esp?email=${encodeURIComponent(user.email)}`);
      const data = await res.json();
      if (Array.isArray(data) && data.length > 0) {
        const latest = data[data.length - 1];
        if (latest.label === "device_connected" && latest.state === "on") {
          connectDeviceBtn.textContent = "Connected ✅";
          connectDeviceBtn.style.backgroundColor = "gold";
          connectDeviceBtn.style.color = "black";
          connectDeviceBtn.disabled = true;
          disconnectDeviceBtn.style.display = "inline-block";
        }
      }
    } catch (err) {
      console.warn("Could not load device status", err);
    }
  }

  // --- CONNECT DEVICE ---
  connectDeviceBtn.addEventListener("click", async () => {
    const device = deviceInput.value.trim();
    if (!device) return alert("Please enter a device name or IP!");

    try {
      const res = await fetch("/api/esp", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: user.email, device })
      });
      const data = await res.json();

      if (data.success) {
        connectDeviceBtn.textContent = "Connected ✅";
        connectDeviceBtn.style.backgroundColor = "gold";
        connectDeviceBtn.style.color = "black";
        connectDeviceBtn.disabled = true;
        disconnectDeviceBtn.style.display = "inline-block";
      } else {
        alert("❌ Connection failed: " + (data.error || "Unknown error"));
      }
    } catch (err) {
      alert("⚠️ Connection error.");
    }
  });

  // --- DISCONNECT DEVICE ---
  disconnectDeviceBtn.addEventListener("click", async () => {
    const device = deviceInput.value.trim();
    if (!device) return alert("Please enter a device name or IP!");

    try {
      const res = await fetch("/api/esp", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: user.email, device })
      });
      const data = await res.json();

      if (data.success) {
        connectDeviceBtn.textContent = "Connect";
        connectDeviceBtn.disabled = false;
        connectDeviceBtn.style.backgroundColor = "";
        connectDeviceBtn.style.color = "";
        disconnectDeviceBtn.style.display = "none";
        alert("✅ Device disconnected successfully!");
      } else {
        alert("❌ Failed to disconnect: " + (data.error || "Unknown error"));
      }
    } catch (err) {
      alert("⚠️ Error disconnecting device.");
    }
  });

  // --- LOAD SWITCHES ---
  async function loadSwitches() {
    try {
      const res = await fetch(`/api/esp?email=${encodeURIComponent(user.email)}`);
      const data = await res.json();
      switchesContainer.innerHTML = "";
      if (!Array.isArray(data) || data.length === 0) {
        switchesContainer.innerHTML = "<p>No switches yet. Add one above.</p>";
        return;
      }

      data.forEach(s => {
        const row = document.createElement("div");
        row.className = "switch-row";
        row.innerHTML = `
          <div class="switch-info">
            <strong class="switch-label">${escapeHtml(s.label)}</strong>
            <small class="switch-ts">${s.timestamp || ''}</small>
          </div>
          <div class="switch-actions">
            <button class="toggle-btn">${s.state === 'on' ? 'Turn Off' : 'Turn On'}</button>
            <button class="edit-btn">Rename</button>
            <button class="remove-btn">Remove</button>
          </div>
        `;

        const toggleBtn = row.querySelector(".toggle-btn");
        const removeBtn = row.querySelector(".remove-btn");
        const editBtn = row.querySelector(".edit-btn");
        const labelElem = row.querySelector(".switch-label");

        toggleBtn.addEventListener("click", async () => {
          const currentState = toggleBtn.textContent.includes("Off") ? "on" : "off";
          const newState = currentState === "on" ? "off" : "on";
          const ok = await updateSwitch(user.email, labelElem.textContent, newState);
          if (ok) toggleBtn.textContent = newState === "on" ? "Turn Off" : "Turn On";
        });

        removeBtn.addEventListener("click", async () => {
          const ok = await removeSwitch(user.email, labelElem.textContent);
          if (ok) row.remove();
        });

        editBtn.addEventListener("click", () => {
          const input = document.createElement("input");
          input.type = "text";
          input.value = labelElem.textContent;
          input.maxLength = 30;
          labelElem.replaceWith(input);
          input.focus();

          input.addEventListener("blur", async () => {
            const newLabel = input.value.trim();
            if (newLabel && newLabel !== labelElem.textContent) {
              const ok = await renameSwitch(user.email, labelElem.textContent, newLabel);
              if (ok) {
                input.replaceWith(labelElem);
                labelElem.textContent = newLabel;
              } else {
                input.replaceWith(labelElem);
              }
            } else {
              input.replaceWith(labelElem);
            }
          });
        });

        switchesContainer.appendChild(row);
      });
    } catch {
      switchesContainer.innerHTML = "<p>Failed to load switches.</p>";
    }
  }

  // --- ADD SWITCH ---
  addSwitchBtn.addEventListener("click", async () => {
    const label = newSwitchInput.value.trim();
    if (!label) return;
    const ok = await updateSwitch(user.email, label, "off");
    if (ok) {
      newSwitchInput.value = "";
      loadSwitches();
    }
  });

  // --- HELPERS ---
  async function updateSwitch(email, label, state) {
    try {
      const res = await fetch("/api/esp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, label, state })
      });
      const data = await res.json();
      return data.success;
    } catch { return false; }
  }

  async function removeSwitch(email, label) {
    try {
      const res = await fetch("/api/esp", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, label })
      });
      const data = await res.json();
      return data.success;
    } catch { return false; }
  }

  async function renameSwitch(email, label, renameTo) {
    try {
      const res = await fetch("/api/esp", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, label, renameTo })
      });
      const data = await res.json();
      return data.success;
    } catch { return false; }
  }

  function escapeHtml(str) {
    if (!str) return "";
    return String(str).replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    })[m]);
  }

  // Load everything
  await loadDeviceStatus();
  await loadSwitches();
});
</script>
</body>
</html>
